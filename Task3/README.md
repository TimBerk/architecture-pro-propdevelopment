# Задание 3. Внешние интеграции

PropDevelopment хочет расширить бизнес-функции для собственников и жильцов. Компания планирует добавить в систему новые сервисы «Умный дом». Эти сервисы готов предоставить партнёр.

Вы согласовали техническое задание с бизнесом и выбрали две услуги для внедрения:
* **Интеллектуальный домофон**. Включает функции классического видеодомофона — открытие по звонку. Также есть возможность распознавать пользователей по биометрии (по лицу) и автоматически открывать дверь, если им разрешён доступ в дом.
* **Интеллектуальный шлагбаум**. Включает функции классического управления шлагбаумом и автоматически открывает доступ, если распознаёт номера автомобилей, которым въезд разрешён.

Новые сервисы должны быть доступны через текущее мобильное приложение, которое используют собственники.

## Что нужно сделать

1. **Подготовьте диаграмму контекста в модели С4**. Она должна отражать контекст, в котором будут работать новые бизнес-функции.
2. **Доработайте диаграмму контейнеров PropDevelopment**. Отразите на ней изменения, которые вы предлагаете сделать в ландшафте систем кампании в связи с внедрением новых бизнес-функций.
3. **Сформируйте список требований, которым должны удовлетворить внешние интеграции**. Для этого:
    * опишите требования к безопасности,
    * выделите протоколы аутентификации и авторизации,
    * опишите, как будет организовано взаимодействие между системами предприятия и внешней платформой.

## Отчёт

![c4.svg](c4.svg)

Добавляется внутреннее приложение для работы с запросами, база данных для хранения настроек устройств и 2 интеграции для работы умного дома.

### Требования к безопасности

1. **Шифрование и транспортный уровень**
    - Все вызовы между мобильным приложением, backend’ом PropDevelopment и платформой партнёра только по HTTPS (TLS 1.2+).
    - mTLS для B2B-интеграции между backend’ом PropDevelopment и API партнёра: сертификаты в корпоративном хранилище, регулярная ротация.
    - Запрет незашифрованных каналов (HTTP, незащищённые MQTT и т. п.).
2. **Защита данных и приватности**
    - Биометрические шаблоны лиц и номера машин не хранятся в мобильном приложении в открытом виде, только в backend’е партнёра и/или PropDevelopment, с шифрованием at rest.
    - Передача только шаблонов/идентификаторов (face_id, vehicle_id), без «сырых» изображений, если это не требуется бизнес-сценарием.
    - Чёткие границы данных: партнёр получает только минимальный набор (идентификатор пользователя, разрешённые точки доступа, временные окна), без лишних данных из CRM/Биллинг.
3. **Управление доступом и принцип наименьших привилегий**
    - Разделение ролей: собственник, жильцы, гости, администраторы УК, оператор партнёра.
    - RBAC/ABAC на уровне PropDevelopment и партнёра: действие «открыть дверь/шлагбаум» разрешено только для субъектов, у которых есть активное право доступа к конкретному объекту (подъезд, дом, парковка).
    - Делегирование прав (выдача гостевых пропусков) должно быть ограничено по времени и зоне доступа.
4. **Защита API**
    - Все внешние API закрываются за API Gateway: rate limiting, защита от brute-force, WAF‑правила против типовых атак (SQLi/XSS/JSON injection).
    - Валидация входных данных (номер телефона, госномер, идентификаторы устройств) на стороне PropDevelopment и партнёра.
    - Логирование всех критичных действий: выпуск/отзыв доступа, попытки открытия, ошибки авторизации — для последующего аудита и расследований.
5. **Управление уязвимостями и compliance**
    - Требование к партнёру: регулярные security‑сканы, обновления, наличие базового сертификационного уровня (например, ISO 27001/SOC2, где применимо).
    - DPA/SLA: прописать ответственность за обработку персональных и биометрических данных (GDPR‑подобные требования, локальное законодательство).

### Протоколы аутентификации и авторизации

1. **Пользователи и мобильное приложение**
    - Продолжать использовать централизованный IAM PropDevelopment.
    - Для мобильного приложения — OAuth 2.0 Authorization Code Flow с PKCE + OpenID Connect для получения ID Token и Access Token на backend PropDevelopment.
    - MFA для чувствительных операций (например, выдача долговременного доступа гостю, привязка нового автомобиля).
2. **Взаимодействие PropDevelopment ↔ платформа партнёра**
    - Авторизация по OAuth 2.0 Client Credentials Flow: backend PropDevelopment получает access token для вызовов API партнёра от имени системы.
    - Токены в формате JWT (RFC 7519), подписаны асимметрично (RS256); партнёр валидирует подпись, audience, issuer и сроки жизни.
    - Скоупы/claims, отражающие минимально необходимый доступ (например, `door.open`, `gate.open`, `access.manage`).
3. **Делегирование прав доступа на уровне дом/подъезд/парковка**
    - PropDevelopment остаётся источником истины по правам собственника:
        - кто имеет доступ к конкретному объекту,
        - в какие временные слоты,
        - по каким идентификаторам (лицо, номер машины, виртуальный ключ).
    - Партнёр принимает от PropDevelopment только список назначенных идентификаторов и их ACL (список устройств/точек доступа + расписания).
    - Отзыв доступа инициируется в системе PropDevelopment и транслируется в сторону партнёра через API (webhook/async или синхронный вызов).

### Взаимодействие между системами

#### Общая схема

- Мобильное приложение ↔ Backend PropDevelopment (все экраны в одном приложении).
- Backend PropDevelopment ↔ Платформа партнёра (B2B API).
- Устройства «домофон/шлагбаум» ↔ Платформа партнёра (низкоуровневый протокол партнёра, не интегрируется напрямую с PropDevelopment).

#### Основные интеграционные потоки

1. **Синхронизация прав доступа**
    - При выдаче/изменении прав собственнику/жильцу PropDevelopment отправляет в API партнёра:
        - идентификатор пользователя (псевдоним, не прямой ID),
        - список точек доступа (подъезд/шлагбаум),
        - тип идентификатора (face_id / plate_number / мобильный ключ),
        - временные ограничения (from–to).
    - При отзыве прав PropDevelopment вызывает API партнёра на удаление/деактивацию соответствующих идентификаторов.
2. **Открытие двери/шлагбаума через приложение**
    - Пользователь в приложении нажимает «Открыть дверь» / «Открыть шлагбаум».
    - Мобильное приложение отправляет запрос на backend PropDevelopment, содержащий объект и контекст пользователя (access token).
    - Backend:
        - проверяет права пользователя на объект,
        - при успехе вызывает API партнёра `/doors/{id}/open` или `/gates/{id}/open` с системным access token (client credentials).
    - Партнёр выполняет команду на устройстве и возвращает статус (успех/ошибка) в PropDevelopment.
3. **Автоматическое открытие по биометрии / номеру авто**
    - Биометрическое распознавание и распознавание номерного знака выполняет платформа партнёра на своей стороне.
    - Локальное устройство (камера/контроллер) передаёт партнёру факт обнаружения лица/номера.
    - Партнёр сверяет с актуальным ACL, полученным от PropDevelopment, и принимает решение (открыть/отклонить).
    - Опционально: партнёр отправляет событие (webhook) в PropDevelopment для аудита («пользователь X вошёл в подъезд Y в T времени»).
4. **Мониторинг и аудит**
    - Все вызовы B2B API проходят через API‑шлюз PropDevelopment с логированием, метриками и алертингом.
    - Партнёр предоставляет журнал событий (либо через API, либо через стрим/webhook), который PropDevelopment агрегирует в единую систему аудита доступа (кто, когда, куда входил/въезжал).
    - Регулярные отчёты и проверка расхождений между ACL в PropDevelopment и у партнёра.